# 项目坐标系分析报告

## 项目结构梳理

### 入口文件
- **`legged_gym/scripts/train_wuji.py`**: 训练入口文件
  - 调用 `task_registry.make_env()` 创建环境
  - 调用 `task_registry.make_alg_runner()` 创建PPO训练器

### 核心文件结构
```
legged_gym/
├── scripts/
│   └── train_wuji.py          # 训练入口
├── envs/
│   ├── base/
│   │   ├── base_task.py       # 基础任务类
│   │   └── legged_robot.py    # 腿式机器人基类
│   └── wuji/
│       ├── wuji_robot_pos_force.py    # Wuji机器人环境实现
│       └── wuji_pos_force_config.py   # 配置文件
└── utils/
    ├── math.py                 # 数学工具函数
    └── isaacgym_utils.py        # Isaac Gym工具函数
```

## 世界坐标系 vs Body坐标系定义

### 1. 世界坐标系 (World Frame / Global Frame)

**定义位置：**
- **来源**: Isaac Gym 的 `root_states` 张量
- **文件**: `legged_gym/envs/wuji/wuji_robot_pos_force.py` 第1270行

```python
# 第1270行：从Isaac Gym获取世界坐标系数据
self.root_states = gymtorch.wrap_tensor(actor_root_state)

# 第1277-1278行：提取世界坐标系中的位置和姿态
self.base_quat = self.root_states[:, 3:7]  # 世界坐标系中的四元数姿态
self.base_pos = self.root_states[:, :3]     # 世界坐标系中的位置
```

**世界坐标系的特点：**
- 固定不变的全局坐标系
- `root_states[:, 0:3]`: 世界坐标系中的位置 (x, y, z)
- `root_states[:, 3:7]`: 世界坐标系中的四元数姿态 (x, y, z, w)
- `root_states[:, 7:10]`: 世界坐标系中的线速度
- `root_states[:, 10:13]`: 世界坐标系中的角速度

### 2. Body坐标系 (Body Frame / Local Frame)

**定义位置：**
- **文件**: `legged_gym/envs/wuji/wuji_robot_pos_force.py` 和 `legged_gym/envs/base/legged_robot.py`
- **关键变量**: `self.base_quat` (机器人基座的姿态四元数)

**Body坐标系的特点：**
- 附着在机器人基座上的局部坐标系
- 随机器人运动而旋转
- 通过 `base_quat` 定义其相对于世界坐标系的旋转

### 3. 坐标系转换函数

**转换函数来源：**
- **文件**: `isaacgym.torch_utils` (Isaac Gym库提供)
- **导入位置**: `legged_gym/envs/wuji/wuji_robot_pos_force.py` 第7行

```python
from isaacgym.torch_utils import *  # 包含 quat_apply, quat_rotate_inverse
```

**关键转换函数：**

1. **`quat_rotate_inverse(quat, vec)`**: 世界坐标系 → Body坐标系
   - 将世界坐标系中的向量转换到body坐标系
   - **使用示例** (第97-99行，`legged_robot.py`):
   ```python
   self.base_lin_vel[:] = quat_rotate_inverse(self.base_quat, self.root_states[:, 7:10])
   self.base_ang_vel[:] = quat_rotate_inverse(self.base_quat, self.root_states[:, 10:13])
   self.projected_gravity[:] = quat_rotate_inverse(self.base_quat, self.gravity_vec)
   ```

2. **`quat_apply(quat, vec)`**: Body坐标系 → 世界坐标系
   - 将body坐标系中的向量转换到世界坐标系
   - **使用示例** (第359行，`wuji_robot_pos_force.py`):
   ```python
   forces_offset_global = quat_apply(self.base_quat, forces_offset_local)
   ```

### 4. 坐标系应用的关键位置

#### 4.1 速度转换 (世界 → Body)
**文件**: `legged_gym/envs/base/legged_robot.py` 第97-99行
```python
self.base_lin_vel[:] = quat_rotate_inverse(self.base_quat, self.root_states[:, 7:10])
self.base_ang_vel[:] = quat_rotate_inverse(self.base_quat, self.root_states[:, 10:13])
```
- **说明**: 将世界坐标系中的速度转换为body坐标系中的速度

#### 4.2 力转换 (Body → 世界)
**文件**: `legged_gym/envs/wuji/wuji_robot_pos_force.py` 第359行
```python
forces_offset_global = quat_apply(self.base_quat, forces_offset_local)
```
- **说明**: 将body坐标系中的力转换为世界坐标系中的力

#### 4.3 力应用时的坐标系选择
**文件**: `legged_gym/envs/wuji/wuji_robot_pos_force.py` 第127行
```python
self.gym.apply_rigid_body_force_tensors(
    self.sim, 
    gymtorch.unwrap_tensor(self.forces[:,:,:3].reshape(-1, 3).contiguous()), 
    None, 
    gymapi.LOCAL_SPACE  # ← 关键：使用局部坐标系
)
```

**对比** (第147行，已注释):
```python
# self.gym.apply_rigid_body_force_tensors(
#     self.sim, 
#     gymtorch.unwrap_tensor(self.forces), 
#     None, 
#     gymapi.GLOBAL_SPACE  # ← 使用世界坐标系
# )
```

**关键区别：**
- `gymapi.LOCAL_SPACE`: 力在body坐标系中定义和应用
- `gymapi.GLOBAL_SPACE`: 力在世界坐标系中定义和应用

#### 4.4 传感器坐标系设置
**文件**: `legged_gym/envs/wuji/wuji_robot_pos_force.py` 第1589行
```python
sensor_props.use_world_frame = False  # ← 传感器数据在body坐标系中
```
- **说明**: 传感器力数据默认在body坐标系中返回

### 5. Base Yaw坐标系 (特殊变体)

在某些场景中，还使用了只考虑yaw角的坐标系：

**文件**: `legged_gym/envs/b2/legged_robot_b2z1_pos_force.py` 第160-162行
```python
base_yaw = euler_from_quat(self.base_quat)[2]
self.base_yaw_quat[:] = quat_from_euler_xyz(torch.tensor(0), torch.tensor(0), base_yaw)
```
- **说明**: 只保留yaw角，忽略roll和pitch，用于某些特定的控制任务

## 总结

### 世界坐标系定义位置：
1. **数据来源**: `root_states` (Isaac Gym提供)
2. **提取位置**: `wuji_robot_pos_force.py:1277-1278`
3. **特点**: 固定全局坐标系

### Body坐标系定义位置：
1. **定义变量**: `base_quat` (机器人基座姿态四元数)
2. **转换函数**: `quat_rotate_inverse()` 和 `quat_apply()` (来自 `isaacgym.torch_utils`)
3. **应用位置**: 
   - 速度转换: `legged_robot.py:97-99`
   - 力转换: `wuji_robot_pos_force.py:359`
   - 力应用: `wuji_robot_pos_force.py:127` (使用 `gymapi.LOCAL_SPACE`)
4. **特点**: 附着在机器人上的局部坐标系，随机器人旋转

### 关键区别：
- **世界坐标系**: 固定不变，所有数据来自Isaac Gym的 `root_states`
- **Body坐标系**: 通过 `base_quat` 定义，使用四元数旋转进行转换
- **转换方向**: 
  - `quat_rotate_inverse(base_quat, world_vec)` → Body坐标系
  - `quat_apply(base_quat, body_vec)` → 世界坐标系




