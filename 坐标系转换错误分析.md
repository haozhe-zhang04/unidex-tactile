# åæ ‡ç³»è½¬æ¢é”™è¯¯åˆ†ææŠ¥å‘Š

## é—®é¢˜æ¦‚è¿°

æ ¹æ®ä½ çš„è¯´æ˜ï¼š
- **F_cmd å’Œ F_ext**ï¼šåŸºäºäº”ä¸ªæŒ‡å°–çš„ **local åæ ‡ç³»**
- **X_cmd, pos_target**ï¼šåŸºäºçµå·§æ‰‹çš„ **base åæ ‡ç³»**
- **æœ€ç»ˆç›®æ ‡**ï¼šæ‰€æœ‰æ•°æ®éƒ½è¦è½¬æ¢åˆ° **base åæ ‡ç³»** ç”¨äº reward å’Œ observation

## ğŸ”´ å‘ç°çš„ä¸¥é‡é”™è¯¯

### é”™è¯¯1ï¼š`commands` ä¸­ F_cmd çš„åæ ‡ç³»ä¸ä¸€è‡´

**ä½ç½®1ï¼š`_push_finger_tip` å‡½æ•°ï¼ˆ1466-1468è¡Œï¼‰**
```python
self.commands[env_ids_apply_push_step1,:, INDEX_TIP_FORCE_X] = self.current_Fxyz_finger_tips_cmd[env_ids_apply_push_step1, :, 0]
```
- `current_Fxyz_finger_tips_cmd` æ˜¯ **finger_tip local** âœ“
- ç›´æ¥èµ‹å€¼ç»™ `commands`ï¼Œæ­¤æ—¶ `commands` ä¸­çš„ F_cmd æ˜¯ **finger_tip local** âœ“

**ä½ç½®2ï¼š`compute_observations` å‡½æ•°ï¼ˆ566-570è¡Œï¼‰**
```python
F_cmd_local = self.commands[:,:,INDEX_TIP_FORCE_X:(INDEX_TIP_FORCE_Z+1)]  # å‡è®¾æ˜¯ finger_tip local
F_cmd_world = quat_apply(self.rigid_state[:,self.finger_tips_idx,3:7].clone(),F_cmd_local)
F_cmd_base = quat_rotate_inverse(base_quat_reshaped,F_cmd_world.reshape(-1,3)).reshape(self.num_envs,num_fingers,3)
commands = self.commands.clone()
commands[:,:,INDEX_TIP_FORCE_X:(INDEX_TIP_FORCE_Z+1)] = F_cmd_base  # âš ï¸ è½¬æ¢åèµ‹å€¼å› commands
```
- **é—®é¢˜**ï¼šè½¬æ¢åèµ‹å€¼å› `commands`ï¼Œå¯¼è‡´ `commands` ä¸­çš„ F_cmd å˜æˆäº† **base åæ ‡ç³»**
- ä½†åç»­ä»£ç ï¼ˆå¦‚ `_draw_ee_force`, `_reward_ee_force_x/y/z`ï¼‰ä»ç„¶å‡è®¾ `commands` ä¸­çš„ F_cmd æ˜¯ **finger_tip local**

**ä½ç½®3ï¼š`_draw_ee_force` å‡½æ•°ï¼ˆ850-851è¡Œï¼‰**
```python
F_cmd = self.commands[:,:,INDEX_TIP_FORCE_X:INDEX_TIP_FORCE_Z+1].clone()
F_cmd_gloal = quat_apply(self.rigid_state[:,self.finger_tips_idx,3:7].clone(),F_cmd)
```
- å‡è®¾ `commands` ä¸­çš„ F_cmd æ˜¯ **finger_tip local**ï¼Œä½†å®é™…å·²ç»æ˜¯ **base**ï¼ˆå¦‚æœæ‰§è¡Œäº† compute_observationsï¼‰

**ä½ç½®4ï¼š`_reward_ee_force_x/y/z` å‡½æ•°ï¼ˆ2406-2439è¡Œï¼‰**
```python
xy_forces_local = self.forces[:, self.finger_tips_idx, 0:3]  # finger_tip local
force_magn_cmd = (self.commands[:, INDEX_TIP_FORCE_X]).view(self.num_envs, 1)  # âš ï¸ å½¢çŠ¶é”™è¯¯ + åæ ‡ç³»é”™è¯¯
```
- **é—®é¢˜1**ï¼š`commands` å½¢çŠ¶æ˜¯ `(num_envs, num_fingers, ...)`ï¼Œä½†è¿™é‡Œåªç”¨äº† `[:, INDEX_TIP_FORCE_X]`ï¼Œç¼ºå°‘ finger ç»´åº¦
- **é—®é¢˜2**ï¼šæ¯”è¾ƒçš„æ˜¯ **finger_tip local** çš„ `forces` å’Œ **base** çš„ `commands`ï¼ˆå¦‚æœæ‰§è¡Œäº† compute_observationsï¼‰ï¼Œåæ ‡ç³»ä¸ä¸€è‡´ï¼

### é”™è¯¯2ï¼šreshape æ“ä½œå¯èƒ½å¯¼è‡´ç´¢å¼•æ··ä¹±

**ä½ç½®ï¼š`compute_observations` å‡½æ•°ï¼ˆ533-554è¡Œï¼‰**

```python
base_quat_reshaped = self.base_quat.unsqueeze(1).expand(self.num_envs, num_fingers, 4).reshape(self.num_envs*num_fingers,4)
base_pos_reshaped = self.base_pos.unsqueeze(1).expand(self.num_envs, num_fingers, 3)

# é—®é¢˜1ï¼šreshape é¡ºåº
finger_tip_pos_base = quat_rotate_inverse(
    base_quat_reshaped,  # (num_envs*num_fingers, 4)
    (finger_tip_pos_world - base_pos_reshaped).reshape(-1,3)  # (num_envs*num_fingers, 3)
).reshape(self.num_envs,num_fingers,3)
```

**æ½œåœ¨é—®é¢˜**ï¼š
- `reshape(-1, 3)` çš„é¡ºåºæ˜¯ï¼š`[env0_finger0, env0_finger1, ..., env0_finger4, env1_finger0, ...]`
- `base_quat_reshaped` çš„é¡ºåºä¹Ÿåº”è¯¥æ˜¯ç›¸åŒçš„
- éœ€è¦éªŒè¯ `expand` å’Œ `reshape` çš„é¡ºåºæ˜¯å¦ä¸€è‡´

**éªŒè¯**ï¼š
```python
# expand åçš„å½¢çŠ¶ï¼š(num_envs, num_fingers, 4)
# reshape åçš„é¡ºåºï¼šæŒ‰è¡Œå±•å¼€ï¼Œå³ [env0_finger0, env0_finger1, ..., env0_finger4, env1_finger0, ...]
# è¿™æ˜¯æ­£ç¡®çš„ âœ“
```

### é”™è¯¯3ï¼š`_reward_tracking_ee_force_base` ä¸­çš„åæ ‡ç³»è½¬æ¢

**ä½ç½®ï¼š`_reward_tracking_ee_force_base` å‡½æ•°ï¼ˆ2274-2284è¡Œï¼‰**

```python
forces_local = self.sensors_forces[:, :, :3]  # finger_tip local âœ“
forces_cmd_local = self.current_Fxyz_finger_tips_cmd  # finger_tip local âœ“
forces_offset_local = (forces_local + forces_cmd_local)

forces_offset_global = quat_apply(self.rigid_state[:,self.finger_tips_idx,3:7].clone(), forces_offset_local)
forces_offset_base = quat_rotate_inverse(
    self.base_quat.unsqueeze(1).expand(self.num_envs, num_fingers, 4).reshape(self.num_envs*num_fingers,4), 
    forces_offset_global.reshape(self.num_envs*num_fingers,3)
).reshape(self.num_envs, num_fingers, 3)
```

**åˆ†æ**ï¼š
- è½¬æ¢é€»è¾‘æ­£ç¡® âœ“
- ä½†éœ€è¦ç¡®ä¿ reshape é¡ºåºä¸€è‡´

### é”™è¯¯4ï¼š`quat_to_mat6d` å‡½æ•°çš„è¾“å…¥å½¢çŠ¶å‡è®¾

**ä½ç½®ï¼š`quat_to_mat6d` å‡½æ•°ï¼ˆ236-247è¡Œï¼‰**

```python
def quat_to_mat6d(quat):
    rot_matrices = quat_to_rotation_matrix(quat) 
    col1 = rot_matrices[:, :, 0] 
    col2 = rot_matrices[:, :, 1]
    mat6d = torch.cat([col1, col2], dim=-1)
    return mat6d
```

**é—®é¢˜**ï¼š
- å‡è®¾è¾“å…¥æ˜¯ `(..., 3, 3)` å½¢çŠ¶
- ä½†åœ¨ `compute_observations` ä¸­è°ƒç”¨æ—¶ï¼š
  ```python
  finger_tip_orn_6d_base = quat_to_mat6d(finger_tip_orn_quat_base)
  ```
  `finger_tip_orn_quat_base` å½¢çŠ¶æ˜¯ `(num_envs, num_fingers, 4)`
  - `quat_to_rotation_matrix` ä¼šè¾“å‡º `(num_envs, num_fingers, 3, 3)` âœ“
  - `col1` å’Œ `col2` å½¢çŠ¶æ˜¯ `(num_envs, num_fingers, 3)` âœ“
  - `mat6d` å½¢çŠ¶æ˜¯ `(num_envs, num_fingers, 6)` âœ“
- **ç»“è®º**ï¼šè¿™ä¸ªå‡½æ•°æ˜¯æ­£ç¡®çš„ âœ“

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šç»Ÿä¸€ `commands` ä¸­ F_cmd çš„åæ ‡ç³»å®šä¹‰

**å»ºè®®**ï¼š`commands` ä¸­çš„ F_cmd **å§‹ç»ˆå­˜å‚¨ base åæ ‡ç³»**çš„å€¼

**ä¿®æ”¹1ï¼š`_push_finger_tip` å‡½æ•°**
```python
# åœ¨èµ‹å€¼å‰è½¬æ¢åˆ° base åæ ‡ç³»
finger_tip_quat = self.rigid_state[:, self.finger_tips_idx, 3:7]  # (num_envs, num_fingers, 4)
base_quat_expanded = self.base_quat.unsqueeze(1).expand(self.num_envs, len(self.finger_tips_idx), 4)

# finger_tip local -> world -> base
F_cmd_world = quat_apply(finger_tip_quat, self.current_Fxyz_finger_tips_cmd)
F_cmd_base = quat_rotate_inverse(
    base_quat_expanded.reshape(-1, 4),
    F_cmd_world.reshape(-1, 3)
).reshape(self.num_envs, len(self.finger_tips_idx), 3)

self.commands[env_ids_apply_push_step1, :, INDEX_TIP_FORCE_X] = F_cmd_base[env_ids_apply_push_step1, :, 0]
self.commands[env_ids_apply_push_step1, :, INDEX_TIP_FORCE_Y] = F_cmd_base[env_ids_apply_push_step1, :, 1]
self.commands[env_ids_apply_push_step1, :, INDEX_TIP_FORCE_Z] = F_cmd_base[env_ids_apply_push_step1, :, 2]
```

**ä¿®æ”¹2ï¼š`compute_observations` å‡½æ•°**
```python
# ç›´æ¥ä½¿ç”¨ commands ä¸­çš„ F_cmdï¼ˆå·²ç»æ˜¯ base åæ ‡ç³»ï¼‰
F_cmd_base = self.commands[:,:,INDEX_TIP_FORCE_X:(INDEX_TIP_FORCE_Z+1)]  # å·²ç»æ˜¯ base âœ“

# ä¸éœ€è¦è½¬æ¢ï¼Œç›´æ¥ä½¿ç”¨
forces_error = sensor_forces_base - F_cmd_base
```

**ä¿®æ”¹3ï¼š`_draw_ee_force` å‡½æ•°**
```python
F_cmd_base = self.commands[:,:,INDEX_TIP_FORCE_X:INDEX_TIP_FORCE_Z+1].clone()  # base åæ ‡ç³»

# è½¬æ¢åˆ° world ç”¨äºå¯è§†åŒ–
base_quat_expanded = self.base_quat.unsqueeze(1).expand(self.num_envs, len(self.finger_tips_idx), 4)
F_cmd_world = quat_apply(
    base_quat_expanded.reshape(-1, 4),
    F_cmd_base.reshape(-1, 3)
).reshape(self.num_envs, len(self.finger_tips_idx), 3)
```

**ä¿®æ”¹4ï¼š`_reward_ee_force_x/y/z` å‡½æ•°**
```python
# è·å–ä¼ æ„Ÿå™¨åŠ›ï¼ˆfinger_tip localï¼‰
sensor_forces_local = self.sensors_forces[:, :, :3]  # (num_envs, num_fingers, 3)

# è½¬æ¢åˆ° base åæ ‡ç³»
finger_tip_quat = self.rigid_state[:, self.finger_tips_idx, 3:7]
base_quat_expanded = self.base_quat.unsqueeze(1).expand(self.num_envs, len(self.finger_tips_idx), 4)

sensor_forces_world = quat_apply(finger_tip_quat, sensor_forces_local)
sensor_forces_base = quat_rotate_inverse(
    base_quat_expanded.reshape(-1, 4),
    sensor_forces_world.reshape(-1, 3)
).reshape(self.num_envs, len(self.finger_tips_idx), 3)

# ä» commands è·å– F_cmdï¼ˆå·²ç»æ˜¯ baseï¼‰
F_cmd_base = self.commands[:, :, INDEX_TIP_FORCE_X:(INDEX_TIP_FORCE_Z+1)]  # (num_envs, num_fingers, 3)

# è®¡ç®—è¯¯å·®ï¼ˆéƒ½åœ¨ base åæ ‡ç³»ï¼‰
force_magn_meas = sensor_forces_base[:, :, 0]  # (num_envs, num_fingers)
force_magn_cmd = F_cmd_base[:, :, 0]  # (num_envs, num_fingers)
force_magn_error = torch.abs(force_magn_meas - force_magn_cmd).mean(dim=1)  # (num_envs,)
```

### æ–¹æ¡ˆ2ï¼šæ·»åŠ è¾…åŠ©å‡½æ•°é¿å…é‡å¤ä»£ç 

```python
def transform_force_finger_tip_local_to_base(self, forces_local):
    """
    å°† finger_tip local åæ ‡ç³»çš„åŠ›è½¬æ¢åˆ° base åæ ‡ç³»
    
    Args:
        forces_local: (num_envs, num_fingers, 3) - finger_tip local åæ ‡ç³»
    
    Returns:
        forces_base: (num_envs, num_fingers, 3) - base åæ ‡ç³»
    """
    num_fingers = forces_local.shape[1]
    finger_tip_quat = self.rigid_state[:, self.finger_tips_idx, 3:7]
    base_quat_expanded = self.base_quat.unsqueeze(1).expand(self.num_envs, num_fingers, 4)
    
    # finger_tip local -> world
    forces_world = quat_apply(
        finger_tip_quat.reshape(-1, 4),
        forces_local.reshape(-1, 3)
    ).reshape(self.num_envs, num_fingers, 3)
    
    # world -> base
    forces_base = quat_rotate_inverse(
        base_quat_expanded.reshape(-1, 4),
        forces_world.reshape(-1, 3)
    ).reshape(self.num_envs, num_fingers, 3)
    
    return forces_base
```

## ğŸ“‹ æ£€æŸ¥æ¸…å•

- [ ] `commands` ä¸­ F_cmd çš„åæ ‡ç³»å®šä¹‰ç»Ÿä¸€ï¼ˆå»ºè®®ï¼šbase åæ ‡ç³»ï¼‰
- [ ] `_push_finger_tip` ä¸­è½¬æ¢ F_cmd åˆ° base åå†èµ‹å€¼
- [ ] `compute_observations` ä¸­ç›´æ¥ä½¿ç”¨ commands çš„ F_cmdï¼ˆä¸å†è½¬æ¢ï¼‰
- [ ] `_draw_ee_force` ä¸­æ­£ç¡®å¤„ç†åæ ‡ç³»è½¬æ¢
- [ ] `_reward_ee_force_x/y/z` ä¸­ç»Ÿä¸€åæ ‡ç³»å¹¶ä¿®å¤å½¢çŠ¶é”™è¯¯
- [ ] éªŒè¯æ‰€æœ‰ reshape æ“ä½œçš„é¡ºåºä¸€è‡´æ€§
- [ ] æ·»åŠ è¾…åŠ©å‡½æ•°é¿å…é‡å¤çš„åæ ‡ç³»è½¬æ¢ä»£ç 

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **reshape é¡ºåº**ï¼šç¡®ä¿æ‰€æœ‰ reshape æ“ä½œéƒ½éµå¾ªç›¸åŒçš„é¡ºåºï¼ˆæŒ‰è¡Œå±•å¼€ï¼‰
2. **æ‰¹é‡å¤„ç†**ï¼šæ³¨æ„ `quat_apply` å’Œ `quat_rotate_inverse` çš„æ‰¹é‡å¤„ç†èƒ½åŠ›
3. **å½¢çŠ¶ä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰å¼ é‡çš„å½¢çŠ¶åŒ¹é…ï¼Œç‰¹åˆ«æ˜¯ `(num_envs, num_fingers, ...)` ç»´åº¦
4. **æµ‹è¯•**ï¼šä¿®å¤åéœ€è¦éªŒè¯åæ ‡ç³»è½¬æ¢çš„æ­£ç¡®æ€§ï¼ˆå¯ä»¥é€šè¿‡å¯è§†åŒ–æˆ–å•å…ƒæµ‹è¯•ï¼‰