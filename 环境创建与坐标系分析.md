# 环境创建与坐标系分析

## 128个环境的创建位置

### 1. 环境数量配置
**配置文件位置**: `legged_gym/envs/base/wuji.py` 或相关配置文件
```python
class env:
    num_envs = 128  # 环境数量（可能在其他配置文件中）
```

### 2. 环境创建流程

#### 2.1 入口点
**文件**: `legged_gym/scripts/train_wuji.py` 第18行
```python
env, env_cfg = task_registry.make_env(name=args.task, args=args, env_cfg=env_cfg)
```

#### 2.2 Simulation创建
**文件**: `legged_gym/envs/wuji/wuji_robot_pos_force.py` 第435-443行
```python
def create_sim(self):
    """ Creates simulation, terrain and evironments
    """
    self.up_axis_idx = 2 # 2 for z, 1 for y -> adapt gravity accordingly
    self.sim = self.gym.create_sim(self.sim_device_id, self.graphics_device_id, 
                                    self.physics_engine, self.sim_params)
    self.terrain = Terrain(self.cfg.terrain, )
    self._create_trimesh()
    self._create_envs()  # ← 在这里创建所有环境
```

**关键点**: 
- **只创建了一个simulation** (`self.sim`)
- 所有128个环境都在这个**同一个simulation**中

#### 2.3 环境实例创建
**文件**: `legged_gym/envs/wuji/wuji_robot_pos_force.py` 第1592-1600行
```python
for i in range(self.num_envs):  # ← 循环创建128个环境
    # create env instance
    env_handle = self.gym.create_env(self.sim, env_lower, env_upper, 
                                     int(np.sqrt(self.num_envs)))
    start_pose = gymapi.Transform()
    start_pose.p = gymapi.Vec3(self.env_origins[i, 0], 
                               self.env_origins[i, 1], 
                               self.env_origins[i, 2])
    # ... 创建actor等
    actor_handle = self.gym.create_actor(env_handle, robot_asset, start_pose, ...)
    self.envs.append(env_handle)
```

**关键点**:
- 每个环境通过 `gym.create_env()` 创建，但都传入**同一个 `self.sim`**
- 每个环境的机器人通过 `env_origins[i]` 设置不同的初始位置

#### 2.4 环境原点计算
**文件**: `legged_gym/envs/wuji/wuji_robot_pos_force.py` 第1648-1661行
```python
def _get_env_origins(self):
    """ Sets environment origins. On rough terrain the origins are defined by the terrain platforms.
    """
    self.custom_origins = True
    self.env_origins = torch.zeros(self.num_envs, 3, device=self.device, requires_grad=False)
    # put robots at the origins defined by the terrain
    max_init_level = self.cfg.terrain.max_init_terrain_level
    if not self.cfg.terrain.curriculum: 
        max_init_level = self.cfg.terrain.num_rows - 1
    self.terrain_levels = torch.randint(0, max_init_level+1, (self.num_envs,), device=self.device)
    self.terrain_types = torch.div(torch.arange(self.num_envs, device=self.device), 
                                   (self.num_envs/self.cfg.terrain.num_cols), 
                                   rounding_mode='floor').to(torch.long)
    self.max_terrain_level = self.cfg.terrain.num_rows
    self.terrain_origins = torch.from_numpy(self.terrain.env_origins).to(self.device).to(torch.float)
    self.env_origins[:] = self.terrain_origins[self.terrain_levels, self.terrain_types]
```

**说明**:
- `env_origins` 是一个形状为 `(num_envs, 3)` 的张量
- 每个环境有自己独立的原点坐标 `(x, y, z)`
- 这些原点定义了每个环境中机器人的初始位置偏移

## 世界坐标系：共享还是独立？

### 答案：**所有128个环境共享同一个世界坐标系**

### 证据1: 单一Simulation
```python
# 第439行：只创建了一个simulation
self.sim = self.gym.create_sim(...)

# 第1595行：所有环境都使用同一个sim
env_handle = self.gym.create_env(self.sim, ...)  # 所有环境共享self.sim
```

### 证据2: 统一的状态张量
**文件**: `legged_gym/envs/wuji/wuji_robot_pos_force.py` 第1256-1270行
```python
def _init_buffers(self):
    # get gym GPU state tensors
    actor_root_state = self.gym.acquire_actor_root_state_tensor(self.sim)  # ← 从同一个sim获取
    # ...
    
    # create some wrapper tensors for different slices
    self.root_states = gymtorch.wrap_tensor(actor_root_state)  # ← 包含所有环境的状态
    # ...
    self.base_quat = self.root_states[:, 3:7]  # ← 所有环境的姿态
    self.base_pos = self.root_states[:, :3]    # ← 所有环境的位置
```

**说明**:
- `root_states` 是一个形状为 `(num_envs, 13)` 的张量
- 所有环境的状态都在**同一个世界坐标系**中表示
- 每个环境的状态通过索引区分：`root_states[i]` 是第i个环境的状态

### 证据3: 位置偏移机制
**文件**: `legged_gym/envs/wuji/wuji_robot_pos_force.py` 第1047行
```python
self.root_states[env_ids, :3] += self.env_origins[env_ids]
```

**说明**:
- 机器人的位置通过 `env_origins` 偏移到不同位置
- 但所有这些位置都在**同一个世界坐标系**中
- 就像在一个大房间里放置128个机器人，每个机器人有自己的位置，但都使用同一个坐标系

### 证据4: 力的应用
**文件**: `legged_gym/envs/wuji/wuji_robot_pos_force.py` 第127行
```python
self.gym.apply_rigid_body_force_tensors(
    self.sim,  # ← 同一个simulation
    gymtorch.unwrap_tensor(self.forces[:,:,:3].reshape(-1, 3).contiguous()), 
    None, 
    gymapi.LOCAL_SPACE
)
```

**说明**:
- 所有环境的力都应用到同一个simulation
- 力的坐标系选择（LOCAL_SPACE vs GLOBAL_SPACE）是相对于每个机器人的body坐标系，但世界坐标系是统一的

## 总结

### 环境创建位置
1. **入口**: `train_wuji.py` → `task_registry.make_env()`
2. **Simulation创建**: `wuji_robot_pos_force.py:435-439` - 创建**一个**simulation
3. **环境创建**: `wuji_robot_pos_force.py:1592-1600` - 在循环中创建128个环境实例
4. **原点计算**: `wuji_robot_pos_force.py:1648-1661` - 计算每个环境的原点位置

### 坐标系结论
- ✅ **所有128个环境共享同一个世界坐标系**
- ✅ 世界坐标系由**单一的simulation** (`self.sim`) 定义
- ✅ 每个环境中的机器人通过 `env_origins` 偏移到不同位置
- ✅ `root_states` 张量包含所有环境的状态，都在同一个世界坐标系中
- ✅ 每个机器人有自己的body坐标系（通过 `base_quat` 定义），但世界坐标系是统一的

### 类比理解
想象一个巨大的体育馆（世界坐标系）：
- 体育馆本身是**世界坐标系**（唯一的）
- 在体育馆中放置了128个机器人（128个环境）
- 每个机器人有自己的位置（`env_origins[i]`）
- 每个机器人有自己的朝向（body坐标系，由 `base_quat` 定义）
- 但所有机器人的位置和朝向都在**同一个体育馆坐标系**（世界坐标系）中描述

### 代码验证
可以通过以下方式验证：
```python
# 查看simulation数量（应该只有1个）
print(f"Simulation: {self.sim}")

# 查看环境数量（应该是128）
print(f"Number of environments: {self.num_envs}")

# 查看所有环境的原点（都在同一个世界坐标系中）
print(f"Environment origins shape: {self.env_origins.shape}")  # (128, 3)
print(f"First env origin: {self.env_origins[0]}")  # 例如: [0, 0, 0]
print(f"Second env origin: {self.env_origins[1]}")  # 例如: [8, 0, 0] (偏移了8米)

# 查看所有机器人的世界坐标位置
print(f"All robots world positions: {self.root_states[:, :3]}")  # (128, 3)
```

